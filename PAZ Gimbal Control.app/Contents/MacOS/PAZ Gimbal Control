#!/bin/bash
# PAZ Gimbal Control - macOS Application Launcher

PROJECT_DIR="/Users/alexmacbookair/Documents/Code/PAZ_Gimbal_Control"
LOG_FILE="$PROJECT_DIR/.paz-gimbal.log"
PID_FILE="$PROJECT_DIR/.paz-gimbal.pid"

cd "$PROJECT_DIR"

# Cleanup function - kills servers when script exits
cleanup() {
    echo "Shutting down PAZ Gimbal Control..." >> "$LOG_FILE"
    pkill -f 'zt_bridge.py' 2>/dev/null
    pkill -f 'vite preview' 2>/dev/null
    rm -f "$PID_FILE"
    exit 0
}

# Trap signals to run cleanup
trap cleanup EXIT INT TERM

# Kill any existing processes
pkill -f 'zt_bridge.py' 2>/dev/null
pkill -f 'vite preview' 2>/dev/null
sleep 1

# Start servers in background
echo "$(date): Starting PAZ Gimbal Control..." > "$LOG_FILE"
python3 server/zt_bridge.py --virtual >> "$LOG_FILE" 2>&1 &
echo $! > "$PID_FILE"
sleep 2

npm run preview >> "$LOG_FILE" 2>&1 &
echo $! >> "$PID_FILE"
sleep 3

# Open browser
open http://localhost:4173

# Show notification
osascript -e 'display notification "Web UI available at http://localhost:4173" with title "PAZ Gimbal Control" subtitle "Servers started"'

# Keep running until killed (Cmd+Q or closing app)
# When the app is closed, macOS sends SIGTERM which triggers cleanup
while true; do
    sleep 60
done
